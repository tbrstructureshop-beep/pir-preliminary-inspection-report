
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manpower Dashboard</title>

  <!-- Google Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #307c91;
      --primary-dark: #245f6f;
      --primary-light: #e6f1f4;
      --bg: #f0f4f7;
      --card: #ffffff;
      --text-main: #0f2f36;
      --text-sub: #5f7f88;
      --accent: #3fa2b8;
      --radius: 16px;
      --shadow: 0 10px 25px -5px rgba(48, 124, 145, 0.1), 0 8px 10px -6px rgba(48, 124, 145, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Status Colors */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, sans-serif;
    }

    body {
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(48, 124, 145, 0.05) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(63, 162, 184, 0.05) 0px, transparent 50%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
      line-height: 1.5;
    }

    .app {
      width: 100%;
      max-width: min(1000px, 100%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- HEADER SECTION --- */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      color: white;
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      top: -20px;
      right: -20px;
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .profile-pic {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.2rem;
    }

    .greeting h1 {
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .employee-meta {
      font-size: 0.8rem;
      opacity: 0.8;
      font-weight: 300;
    }

    /* --- DASHBOARD SECTIONS --- */
    .section-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid rgba(255,255,255,0.8);
    }

    .section-header {
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: #fff;
    }

    .section-header h2 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chevron {
      font-size: 0.8rem;
      color: var(--text-sub);
      transition: transform 0.3s ease;
    }

    .collapsed .chevron {
      transform: rotate(-90deg);
    }

    .collapsed .section-content {
      display: none;
    }

    .section-content {
      padding: 0 20px 20px 20px;
    }

    /* --- SLIDABLE TABLE SYSTEM --- */
    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--primary-light);
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      min-width: 450px;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid var(--primary-light);
      white-space: nowrap;
    }

    th {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    td {
      color: var(--text-main);
    }

    /* --- BADGES --- */
    .badge {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      display: inline-block;
    }

    .bg-present { background: #ecfdf5; color: #065f46; }
    .bg-absent { background: #fef2f2; color: #991b1b; }
    .bg-idle { background: #fffbeb; color: #92400e; }

    /* --- EMPTY STATES --- */
    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--text-sub);
      font-size: 0.8rem;
      font-style: italic;
      background: var(--primary-light);
      border-radius: 12px;
      margin: 10px 0;
    }

    /* Sub-group Styling */
    .sub-group-wrapper { margin-top: 30px; }

    .sub-group-title {
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-left: 5px;
    }

    .title-on-duty { color: #10b981; border-left: 4px solid #10b981; padding-left: 10px; }
    .title-off-duty { color: #64748b; border-left: 4px solid #64748b; padding-left: 10px; }

    #onDutyTable th { background: #ecfdf5; color: #065f46; border-bottom: 2px solid #10b981; }
    #offDutyTable th { background: #f1f5f9; color: #475569; border-bottom: 2px solid #64748b; }
    #offDutyTable tbody tr { background-color: #fafafa; opacity: 0.85; }

    /* ================================
       RESPONSIVE SYSTEM
    ================================ */

    @media (max-width: 1024px) {
      .app { max-width: 95%; }
      header { padding: 20px; }
      .section-content { padding: 0 16px 16px; }
    }

    @media (max-width: 768px) {
      body { padding: 12px; }

      header { padding: 16px; }
      .profile-pic { width: 42px; height: 42px; font-size: 1rem; }
      .greeting h1 { font-size: 1rem; }
      .employee-meta { font-size: 0.7rem; }

      .section-header h2 { font-size: 0.75rem; }

      table { font-size: 0.75rem; min-width: 500px; }
      th, td { padding: 10px 8px; }

      .badge { font-size: 0.65rem; padding: 3px 8px; }
    }

    @media (max-width: 480px) {
      header { padding: 14px; }

      .profile-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .section-content { padding: 0 14px 14px; }

      table { min-width: 380px; }
    }
  </style>
</head>


<body>

  <div class="app">
    
    <!-- PROFILE HEADER -->
    <header>
      <div class="profile-info">
        <div class="profile-pic" id="dhInitials">--</div>
        <div class="greeting">
          <h1 id="dhName">Loading...</h1>
          <div class="employee-meta">
            ID: <span id="dhId">...</span> | Dept: <span id="dhUnit">...</span>
          </div>
        </div>
      </div>
      <div id="dhStatus" class="badge bg-idle">Checking Status...</div>
    </header>

    <!-- ATTENDANCE SECTION -->
    <div class="section-card" id="attendanceSection">
      <div class="section-header">
        <h2><i class="fas fa-users-viewfinder"></i> Manpower Attendance</h2>
        <i class="fas fa-chevron-down chevron"></i>
      </div>
      
      <div class="section-content">
        <div id="mainEmptyState" class="empty-state" style="display:none;">
          No Attendance Record For Today
        </div>

        <!-- ON DUTY SUB-SECTION -->
        <div class="sub-group-wrapper">
          <div class="sub-group-title title-on-duty">
            <i class="fas fa-circle-check"></i> ON DUTY PERSONNEL
          </div>
          <div class="table-container">
            <table id="onDutyTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Clock-In</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows injected here -->
              </tbody>
            </table>
            <div class="empty-state" id="onDutyEmpty" style="display:none;">No personnel on duty</div>
          </div>
        </div>

        <!-- OFF DUTY SUB-SECTION -->
        <div class="sub-group-wrapper">
          <div class="sub-group-title title-off-duty">
            <i class="fas fa-clock-rotate-left"></i> OFF DUTY PERSONNEL
          </div>
          <div class="table-container">
            <table id="offDutyTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>In</th>
                  <th>Out</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows injected here -->
              </tbody>
            </table>
            <div class="empty-state" id="offDutyEmpty" style="display:none;">No personnel off duty</div>
          </div>
        </div>
      </div> <!-- End Section Content -->
    </div> <!-- End Section Card -->

    <!-- ACTION LOG SECTION -->
    <div class="section-card collapsed" id="logSection">
      <div class="section-header">
        <h2><i class="fas fa-list-check"></i> Action Log</h2>
        <i class="fas fa-chevron-down chevron"></i>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Work Order</th>
                <th>Task</th>
                <th>Time</th>
                <th>Action</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="empty-state" id="logEmpty" style="display:none;">No Action Log for today</div>
      </div>
    </div>

  </div> <!-- End App -->
  
<script src="../../auth/script.js"></script>
<script>
  
// 1. Protect the page and get user info
const user = protectPage();
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4MAK0BJYSFKhx70R7JIasZnwRFhGrTPOCsZmo16R8b9Gzim5gZSrTgOSUTqoYUOFVKQ/exec"; 

  
/**
 * Fetch and Fill Department Head Data */
  
async function loadDHHeader() {
  if (!user || !user.userId) {
    console.warn("User not logged in yet...");
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?userId=${user.userId}&action=getDHData`);
    const data = await response.json();

    if (data.success) {
      // Fill Text Data
      document.getElementById("dhName").textContent = data.name;
      document.getElementById("dhId").textContent = data.id;
      document.getElementById("dhUnit").textContent = data.unit;
      
      // Handle Initials
      const initials = data.name.split(" ").map(n => n[0]).join("").toUpperCase();
      document.getElementById("dhInitials").textContent = initials.substring(0, 2);

      // --- SYNC STATUS & CSS ---
      const statusBadge = document.getElementById("dhStatus");
      let displayText = "";
      let cssClass = "";

      switch (data.attendanceStatus) {
        case "On Duty":
          displayText = "On Duty";
          cssClass = "bg-present"; // Green
          break;
        case "Not Yet Present":
        case "Absent":
          displayText = data.attendanceStatus;
          cssClass = "bg-absent";  // Red
          break;
        case "On Leave":
          displayText = "On Leave";
          cssClass = "bg-idle";    // Yellow
          break;
        case "Shift Completed":
          displayText = "Off Duty";
          cssClass = "bg-completed"; // Grey
          break;
        default:
          displayText = data.attendanceStatus || "Unknown";
          cssClass = "bg-idle";
      }

      statusBadge.textContent = displayText;
      // IMPORTANT: Reset classes and apply 'badge' + the specific color class
      statusBadge.className = `badge ${cssClass}`;
      
    } else {
      document.getElementById("dhName").textContent = "Data Not Found";
    }
  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("dhName").textContent = "Connection Error";
  }
}

async function fetchAndRenderAttendance() {
  const user = protectPage();
  if (!user || !user.unit) return;
  try {
    const response = await fetch(`${WEB_APP_URL}?action=getAttendanceData&unit=${encodeURIComponent(user.unit)}`);
    const data = await response.json();
    renderAttendance(data);
  } catch (error) {
    console.error("Error:", error);
    renderAttendance([]);
  }
}

function renderAttendance(data) {
  const onDutyBody = document.querySelector("#onDutyTable tbody");
  const offDutyBody = document.querySelector("#offDutyTable tbody");
  
  onDutyBody.innerHTML = "";
  offDutyBody.innerHTML = "";

  const onDutyList = data.filter(p => p.isDuty);
  const offDutyList = data.filter(p => !p.isDuty);

  // Toggle empty state visibility
  document.getElementById("onDutyEmpty").style.display = onDutyList.length === 0 ? "block" : "none";
  document.getElementById("offDutyEmpty").style.display = offDutyList.length === 0 ? "block" : "none";

  // Render Group 1: On Duty
  onDutyList.forEach(p => {
    const statusClass = p.status === "On Task" ? "status-green" : "bg-idle"; // Green for working, Yellow for Idle
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    onDutyBody.appendChild(tr);
  });

  // Render Group 2: Off Duty
  offDutyList.forEach(p => {
    const statusClass = p.status === "Required STOP" ? "status-red" : "bg-completed"; // Red for Error, Grey for Finished
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td>${p.clockOut}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    offDutyBody.appendChild(tr);
  });
}
  

// Revised fetchAndRenderLog
async function fetchAndRenderLog(unit) {
  const logTableBody = document.querySelector("#logTable tbody");
  const logEmpty = document.getElementById("logEmpty");
  
  if (!unit) {
    logEmpty.style.display = "block";
    logEmpty.innerText = "Unit not identified.";
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?action=getActionLog&unit=${encodeURIComponent(unit)}`);
    const data = await response.json();

    logTableBody.innerHTML = ""; // Clear existing rows

    if (!data || data.length === 0) {
      logEmpty.style.display = "block";
      return;
    }

    logEmpty.style.display = "none";
    
    const rowsHtml = data.map(row => {
      let statusClass = "bg-completed"; 
      const status = (row.status || "").toLowerCase();
      
      if (status.includes("progress") || status.includes("running")) statusClass = "bg-idle";
      if (status.includes("start") || status.includes("open")) statusClass = "status-green";
      if (status.includes("stop") || status.includes("hold")) statusClass = "status-red";

      return `
        <tr>
          <td><strong>${row.employeeId}</strong></td>
          <td>${row.workOrder}</td>
          <td>${row.task}</td>
          <td>${row.time}</td>
          <td>${row.action}</td>
          <td><span class="badge ${statusClass}">${row.status}</span></td>
        </tr>
      `;
    }).join('');

    logTableBody.innerHTML = rowsHtml;

  } catch (error) {
    console.error("Log Error:", error);
    logEmpty.style.display = "block";
    logEmpty.innerText = "Error loading logs.";
  }
}


function setupCollapse(sectionId) {
  const section = document.getElementById(sectionId);
  section.querySelector(".section-header").addEventListener("click", () => {
    section.classList.toggle("collapsed");
  });
}

// --- IMPORTANT: Fixed DOMContentLoaded ---
window.addEventListener("DOMContentLoaded", () => {
  setupCollapse("attendanceSection");
  setupCollapse("logSection");
  
  loadDHHeader(); 
  
  // Call functions using the 'user' object retrieved at top of script
  if (user && user.unit) {
    fetchAndRenderAttendance();
    fetchAndRenderLog(user.unit); // Pass the unit here
  }
});
  
</script>
</body>
</html>
