<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manpower Dashboard</title>

  <!-- Google Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #307c91;
      --primary-dark: #245f6f;
      --primary-light: #e6f1f4;
      --bg: #f8fafc;
      --card: #ffffff;
      --text-main: #0f2f36;
      --text-sub: #64748b;
      --accent: #3fa2b8;
      --radius: 16px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 25px -5px rgba(48, 124, 145, 0.15);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Status Colors */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(48, 124, 145, 0.03) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(63, 162, 184, 0.03) 0px, transparent 50%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      /* Responsive padding */
      padding: clamp(10px, 3vw, 40px);
      line-height: 1.6;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: clamp(15px, 4vw, 25px);
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- HEADER SECTION --- */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: var(--radius);
      padding: clamp(20px, 5vw, 32px);
      box-shadow: var(--shadow-lg);
      color: white;
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      top: -30px;
      right: -30px;
      width: clamp(100px, 20vw, 150px);
      height: clamp(100px, 20vw, 150px);
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .profile-pic {
      width: clamp(45px, 10vw, 55px);
      height: clamp(45px, 10vw, 55px);
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .greeting h1 {
      font-size: clamp(1.1rem, 4vw, 1.4rem);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .employee-meta {
      font-size: clamp(0.75rem, 3vw, 0.85rem);
      opacity: 0.9;
      font-weight: 400;
      margin-top: 2px;
    }

    /* --- DASHBOARD SECTIONS --- */
    .section-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid rgba(0,0,0,0.05);
    }

    /* Desktop Hover Effect */
    @media (min-width: 1024px) {
        .section-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
    }

    .section-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: #fff;
      user-select: none;
    }

    .section-header h2 {
      font-size: clamp(0.8rem, 3vw, 0.9rem);
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chevron {
      font-size: 0.9rem;
      color: var(--text-sub);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 5px;
    }

    .collapsed .chevron {
      transform: rotate(-180deg);
    }

    .collapsed .section-content {
      display: none;
    }

    .section-content {
      padding: 0 20px 20px 20px;
    }

    /* --- RESPONSIVE TABLE SYSTEM --- */
    .table-outer {
      position: relative; /* For potential custom scroll indicators */
      width: 100%;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #f1f5f9;
      -webkit-overflow-scrolling: touch; /* Smooth momentum scrolling */
    }

    /* Scrollbar Styling */
    .table-container::-webkit-scrollbar {
      height: 6px;
    }
    .table-container::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    .table-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    table {
      width: 100%;
      min-width: 600px; /* Forces scroll on mobile while keeping desktop clean */
      border-collapse: collapse;
      font-size: clamp(0.8rem, 2.5vw, 0.875rem);
    }

    th {
      background: #f8fafc;
      color: var(--primary-dark);
      text-align: left;
      padding: 14px 16px;
      font-weight: 600;
      white-space: nowrap;
      position: sticky;
      top: 0;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text-main);
      white-space: nowrap;
    }

    tr:last-child td { border-bottom: none; }

    /* --- BADGES --- */
    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .bg-present { background: #dcfce7; color: #166534; }
    .bg-absent { background: #fee2e2; color: #991b1b; }
    .bg-idle { background: #fef3c7; color: #92400e; }

    /* --- SUB-GROUPS --- */
    .sub-group-wrapper {
      margin-top: 25px;
    }

    .sub-group-title {
      font-size: clamp(0.75rem, 3vw, 0.8rem);
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-on-duty {
      color: var(--success);
      padding-left: 12px;
      border-left: 4px solid var(--success);
    }

    .title-off-duty {
      color: var(--text-sub);
      padding-left: 12px;
      border-left: 4px solid #cbd5e1;
    }

    /* Mobile-only hint */
    .scroll-hint {
        display: none;
        font-size: 0.7rem;
        color: var(--text-sub);
        text-align: right;
        margin-bottom: 5px;
    }

    @media (max-width: 768px) {
        .scroll-hint { display: block; }
        .section-header { padding: 15px; }
        .section-content { padding: 0 15px 15px 15px; }
    }
  </style>
</head>
<body>

  <div class="app">
    
    <!-- PROFILE HEADER -->
    <header>
      <div class="profile-info">
        <div class="profile-pic" id="dhInitials">--</div>
        <div class="greeting">
          <h1 id="dhName">Loading...</h1>
          <div class="employee-meta">
            ID: <span id="dhId">...</span> | Dept: <span id="dhUnit">...</span>
          </div>
        </div>
      </div>
      <div id="dhStatus" class="badge bg-idle">Checking Status...</div>
    </header>

    <!-- ATTENDANCE SECTION -->
    <div class="section-card" id="attendanceSection">
      <div class="section-header">
        <h2><i class="fas fa-users-viewfinder"></i> Manpower Attendance</h2>
        <i class="fas fa-chevron-down chevron"></i>
      </div>
      
      <div class="section-content">
        <div id="mainEmptyState" class="empty-state" style="display:none;">
          No Attendance Record For Today
        </div>

        <!-- ON DUTY SUB-SECTION -->
        <div class="sub-group-wrapper">
          <div class="sub-group-title title-on-duty">
            <i class="fas fa-circle-check"></i> ON DUTY PERSONNEL
          </div>
          <div class="table-container">
            <table id="onDutyTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Clock-In</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows injected here -->
              </tbody>
            </table>
            <div class="empty-state" id="onDutyEmpty" style="display:none;">No personnel on duty</div>
          </div>
        </div>

        <!-- OFF DUTY SUB-SECTION -->
        <div class="sub-group-wrapper">
          <div class="sub-group-title title-off-duty">
            <i class="fas fa-clock-rotate-left"></i> OFF DUTY PERSONNEL
          </div>
          <div class="table-container">
            <table id="offDutyTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>In</th>
                  <th>Out</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows injected here -->
              </tbody>
            </table>
            <div class="empty-state" id="offDutyEmpty" style="display:none;">No personnel off duty</div>
          </div>
        </div>
      </div> <!-- End Section Content -->
    </div> <!-- End Section Card -->

    <!-- ACTION LOG SECTION -->
    <div class="section-card collapsed" id="logSection">
      <div class="section-header">
        <h2><i class="fas fa-list-check"></i> Action Log</h2>
        <i class="fas fa-chevron-down chevron"></i>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Work Order</th>
                <th>Task</th>
                <th>Time</th>
                <th>Action</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="empty-state" id="logEmpty" style="display:none;">No Action Log for today</div>
      </div>
    </div>

  </div> <!-- End App -->
  
<script src="../../auth/script.js"></script>
<script>
  
// 1. Protect the page and get user info
const user = protectPage();
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4MAK0BJYSFKhx70R7JIasZnwRFhGrTPOCsZmo16R8b9Gzim5gZSrTgOSUTqoYUOFVKQ/exec"; 

  
/**
 * Fetch and Fill Department Head Data */
  
async function loadDHHeader() {
  if (!user || !user.userId) {
    console.warn("User not logged in yet...");
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?userId=${user.userId}&action=getDHData`);
    const data = await response.json();

    if (data.success) {
      // Fill Text Data
      document.getElementById("dhName").textContent = data.name;
      document.getElementById("dhId").textContent = data.id;
      document.getElementById("dhUnit").textContent = data.unit;
      
      // Handle Initials
      const initials = data.name.split(" ").map(n => n[0]).join("").toUpperCase();
      document.getElementById("dhInitials").textContent = initials.substring(0, 2);

      // --- SYNC STATUS & CSS ---
      const statusBadge = document.getElementById("dhStatus");
      let displayText = "";
      let cssClass = "";

      switch (data.attendanceStatus) {
        case "On Duty":
          displayText = "On Duty";
          cssClass = "bg-present"; // Green
          break;
        case "Not Yet Present":
        case "Absent":
          displayText = data.attendanceStatus;
          cssClass = "bg-absent";  // Red
          break;
        case "On Leave":
          displayText = "On Leave";
          cssClass = "bg-idle";    // Yellow
          break;
        case "Shift Completed":
          displayText = "Off Duty";
          cssClass = "bg-completed"; // Grey
          break;
        default:
          displayText = data.attendanceStatus || "Unknown";
          cssClass = "bg-idle";
      }

      statusBadge.textContent = displayText;
      // IMPORTANT: Reset classes and apply 'badge' + the specific color class
      statusBadge.className = `badge ${cssClass}`;
      
    } else {
      document.getElementById("dhName").textContent = "Data Not Found";
    }
  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("dhName").textContent = "Connection Error";
  }
}

async function fetchAndRenderAttendance() {
  const user = protectPage();
  if (!user || !user.unit) return;
  try {
    const response = await fetch(`${WEB_APP_URL}?action=getAttendanceData&unit=${encodeURIComponent(user.unit)}`);
    const data = await response.json();
    renderAttendance(data);
  } catch (error) {
    console.error("Error:", error);
    renderAttendance([]);
  }
}

function renderAttendance(data) {
  const onDutyBody = document.querySelector("#onDutyTable tbody");
  const offDutyBody = document.querySelector("#offDutyTable tbody");
  
  onDutyBody.innerHTML = "";
  offDutyBody.innerHTML = "";

  const onDutyList = data.filter(p => p.isDuty);
  const offDutyList = data.filter(p => !p.isDuty);

  // Toggle empty state visibility
  document.getElementById("onDutyEmpty").style.display = onDutyList.length === 0 ? "block" : "none";
  document.getElementById("offDutyEmpty").style.display = offDutyList.length === 0 ? "block" : "none";

  // Render Group 1: On Duty
  onDutyList.forEach(p => {
    const statusClass = p.status === "On Task" ? "status-green" : "bg-idle"; // Green for working, Yellow for Idle
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    onDutyBody.appendChild(tr);
  });

  // Render Group 2: Off Duty
  offDutyList.forEach(p => {
    const statusClass = p.status === "Required STOP" ? "status-red" : "bg-completed"; // Red for Error, Grey for Finished
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td>${p.clockOut}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    offDutyBody.appendChild(tr);
  });
}
  

// Revised fetchAndRenderLog
async function fetchAndRenderLog(unit) {
  const logTableBody = document.querySelector("#logTable tbody");
  const logEmpty = document.getElementById("logEmpty");
  
  if (!unit) {
    logEmpty.style.display = "block";
    logEmpty.innerText = "Unit not identified.";
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?action=getActionLog&unit=${encodeURIComponent(unit)}`);
    const data = await response.json();

    logTableBody.innerHTML = ""; // Clear existing rows

    if (!data || data.length === 0) {
      logEmpty.style.display = "block";
      return;
    }

    logEmpty.style.display = "none";
    
    const rowsHtml = data.map(row => {
      let statusClass = "bg-completed"; 
      const status = (row.status || "").toLowerCase();
      
      if (status.includes("progress") || status.includes("running")) statusClass = "bg-idle";
      if (status.includes("start") || status.includes("open")) statusClass = "status-green";
      if (status.includes("stop") || status.includes("hold")) statusClass = "status-red";

      return `
        <tr>
          <td><strong>${row.employeeId}</strong></td>
          <td>${row.workOrder}</td>
          <td>${row.task}</td>
          <td>${row.time}</td>
          <td>${row.action}</td>
          <td><span class="badge ${statusClass}">${row.status}</span></td>
        </tr>
      `;
    }).join('');

    logTableBody.innerHTML = rowsHtml;

  } catch (error) {
    console.error("Log Error:", error);
    logEmpty.style.display = "block";
    logEmpty.innerText = "Error loading logs.";
  }
}


function setupCollapse(sectionId) {
  const section = document.getElementById(sectionId);
  section.querySelector(".section-header").addEventListener("click", () => {
    section.classList.toggle("collapsed");
  });
}

// --- IMPORTANT: Fixed DOMContentLoaded ---
window.addEventListener("DOMContentLoaded", () => {
  setupCollapse("attendanceSection");
  setupCollapse("logSection");
  
  loadDHHeader(); 
  
  // Call functions using the 'user' object retrieved at top of script
  if (user && user.unit) {
    fetchAndRenderAttendance();
    fetchAndRenderLog(user.unit); // Pass the unit here
  }
});
  
</script>
</body>
</html>
