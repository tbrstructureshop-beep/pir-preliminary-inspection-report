<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance & Manpower Dashboard</title>

<style>
:root {
  --primary: #307c91;
  --secondary: #245e6f;
  --bg: #f4f8fa;
  --text: #1f2d33;
  --muted: #6b7c85;
  --success: #2e9f6e;
  --danger: #c94b4b;
  --warning: #d8a441;
  --info: #4b8cc9;
}

* {
  box-sizing: border-box;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.card {
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

.header-card {
  display: flex;
  gap: 16px;
  align-items: center;
}

.profile-pic {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 28px;
  font-weight: 600;
  flex-shrink: 0;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
}

.info-item {
  font-size: 14px;
}

.info-item span {
  color: var(--muted);
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

/* Status Colors */
.status-green { background: rgba(46, 159, 110, 0.15); color: var(--success); }
.status-red { background: rgba(201, 75, 75, 0.15); color: var(--danger); }
.badge.on-duty { background: rgba(46, 159, 110, 0.15); color: var(--success); }
.badge.off-duty { background: rgba(107, 124, 133, 0.15); color: var(--muted); }

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}

.section-header h2 {
  font-size: 16px;
  margin: 0;
}

.sub-group-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--primary);
  margin: 20px 0 10px 0;
  border-left: 4px solid var(--primary);
  padding-left: 8px;
}

.chevron {
  transition: transform 0.3s ease;
}

.section.collapsed .chevron {
  transform: rotate(-90deg);
}

.section-content {
  margin-top: 12px;
  transition: max-height 0.35s ease, opacity 0.3s ease;
}

.section.collapsed .section-content {
  max-height: 0;
  opacity: 0;
  overflow: hidden;
}

.table-wrapper {
  width: 100%;
  overflow-x: auto;
  margin-bottom: 20px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

th, td {
  padding: 10px 12px;
  text-align: left;
  font-size: 13px;
  border-bottom: 1px solid #e6eef2;
  white-space: nowrap;
}

th {
  color: var(--muted);
  font-weight: 600;
  background: #fafcfd;
}

.empty-state {
  padding: 10px;
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  font-style: italic;
}

@media (min-width: 768px) {
  .info-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>

<body>
<div class="container">

  <!-- SECTION 1: HEADER -->
  <div class="card header-card">
    <div class="profile-pic" id="dhInitials">--</div>
    <div class="info-grid">
      <div class="info-item"><span>Name:</span> <span id="dhName">Loading...</span></div>
      <div class="info-item"><span>Employee ID:</span> <span id="dhId">...</span></div>
      <div class="info-item"><span>Department Code:</span> <span id="dhUnit">...</span></div>
      <div class="info-item">
        <span>Attended Status:</span>
        <span id="dhStatus" class="badge">Checking...</span>
      </div>
    </div>
  </div>

  <!-- SECTION 2: ATTENDANCE GROUPS -->
  <div class="card section" id="attendanceSection">
    <div class="section-header">
      <h2>Manpower Attendance Status</h2>
      <div class="chevron">▼</div>
    </div>
    
    <div class="section-content">
      <!-- Group 1: ON DUTY -->
      <div class="sub-group-title">ON DUTY PERSONNEL</div>
      <div class="table-wrapper">
        <table id="onDutyTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Clock-In</th>
              <th>Assignment Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="empty-state" id="onDutyEmpty" style="display:none;">No personnel on duty</div>
      </div>

      <!-- Group 2: OFF DUTY -->
      <div class="sub-group-title">OFF DUTY PERSONNEL</div>
      <div class="table-wrapper">
        <table id="offDutyTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Clock-In</th>
              <th>Clock-Out</th>
              <th>Completion Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="empty-state" id="offDutyEmpty" style="display:none;">No personnel off duty</div>
      </div>
    </div>
  </div>

  <!-- SECTION 3: ACTION LOG -->
  <div class="card section collapsed" id="logSection">
    <div class="section-header">
      <h2>Manpower Action Log</h2>
      <div class="chevron">▼</div>
    </div>
    <div class="section-content">
      <div class="table-wrapper">
        <table id="logTable">
          <thead>
            <tr>
              <th>Employee ID</th>
              <th>Work Order</th>
              <th>Task</th>
              <th>Time</th>
              <th>Action</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="empty-state" id="logEmpty" style="display:none;">No records available</div>
    </div>
  </div>

</div>

<script src="../../auth/script.js"></script>
<script>
  
// 1. Protect the page and get user info
const user = protectPage();
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4MAK0BJYSFKhx70R7JIasZnwRFhGrTPOCsZmo16R8b9Gzim5gZSrTgOSUTqoYUOFVKQ/exec"; 
  
// Mock Data (Updated to match your requirements)
const attendanceData = [
  { id: "EMP-2101", name: "John Doe", clockIn: "07:45", clockOut: "-", isDuty: true, status: "Idle" },
  { id: "EMP-2102", name: "Jane Smith", clockIn: "07:52", clockOut: "-", isDuty: true, status: "On Task" },
  { id: "EMP-2103", name: "Mike Ross", clockIn: "08:00", clockOut: "17:05", isDuty: false, status: "Completely STOP" },
  { id: "EMP-2104", name: "Harvey Specter", clockIn: "08:15", clockOut: "16:30", isDuty: false, status: "STOP Required" }
];

const actionLogData = [
  { employeeId: "EMP-2102", workOrder: "WO-88921", task: "Inspection", time: "09:15", action: "Started", progression: "In Progress" }
];

/**
 * Fetch and Fill Department Head Data
 */
async function loadDHHeader() {
  if (!user || !user.userId) {
    console.warn("User not logged in yet...");
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?userId=${user.userId}&action=getDHData`);
    const data = await response.json();

    if (data.success) {
      document.getElementById("dhName").textContent = data.name;
      document.getElementById("dhId").textContent = data.id;
      document.getElementById("dhUnit").textContent = data.unit;
      
      const statusBadge = document.getElementById("dhStatus");
      
      // --- START MAPPING LOGIC ---
      let displayText = "";
      let cssClass = "";

      // We look at what the GAS returned and map it to your requirements
      switch (data.attendanceStatus) {
        case "Not Yet Present":
          displayText = "belum hadir";
          cssClass = "absent"; // Red color
          break;
        case "On Duty":
          displayText = "On Duty";
          cssClass = "present"; // Green color
          break;
        case "Shift Completed":
          displayText = "Off Duty";
          cssClass = "completed"; // Grey color
          break;
        case "Absent":
          displayText = "Absent";
          cssClass = "absent"; // Red color
          break;
        case "On Leave":
          displayText = "On Leave";
          cssClass = "idle"; // Yellow/Orange color
          break;
        default:
          displayText = data.attendanceStatus || "Unknown";
          cssClass = data.statusCode || "idle";
      }

      statusBadge.textContent = displayText;
      statusBadge.className = `badge ${cssClass}`;
      // --- END MAPPING LOGIC ---

      const initials = data.name.split(" ").map(n => n[0]).join("").toUpperCase();
      document.getElementById("dhInitials").textContent = initials.substring(0, 2);
    } else {
      document.getElementById("dhName").textContent = "No DH Assigned";
    }
  } catch (err) {
    document.getElementById("dhName").textContent = "Connection Error";
    console.error("Fetch error:", err);
  }
}

  
  
function renderAttendance() {
  const onDutyBody = document.querySelector("#onDutyTable tbody");
  const offDutyBody = document.querySelector("#offDutyTable tbody");
  const onDutyEmpty = document.getElementById("onDutyEmpty");
  const offDutyEmpty = document.getElementById("offDutyEmpty");

  onDutyBody.innerHTML = "";
  offDutyBody.innerHTML = "";

  const onDutyList = attendanceData.filter(p => p.isDuty);
  const offDutyList = attendanceData.filter(p => !p.isDuty);

  // Render ON DUTY
  if (onDutyList.length === 0) onDutyEmpty.style.display = "block";
  else {
    onDutyEmpty.style.display = "none";
    onDutyList.forEach(p => {
      const statusClass = p.status === "On Task" ? "status-green" : "status-red";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.clockIn}</td>
        <td><span class="badge ${statusClass}">${p.status}</span></td>
      `;
      onDutyBody.appendChild(tr);
    });
  }

  // Render OFF DUTY
  if (offDutyList.length === 0) offDutyEmpty.style.display = "block";
  else {
    offDutyEmpty.style.display = "none";
    offDutyList.forEach(p => {
      const statusClass = p.status === "Completely STOP" ? "status-green" : "status-red";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.clockIn}</td>
        <td>${p.clockOut}</td>
        <td><span class="badge ${statusClass}">${p.status}</span></td>
      `;
      offDutyBody.appendChild(tr);
    });
  }
}

function renderLog() {
  const tbody = document.querySelector("#logTable tbody");
  tbody.innerHTML = actionLogData.map(row => `
    <tr>
      <td>${row.employeeId}</td>
      <td>${row.workOrder}</td>
      <td>${row.task}</td>
      <td>${row.time}</td>
      <td>${row.action}</td>
      <td><span class="badge">${row.progression}</span></td>
    </tr>
  `).join('');
}

function setupCollapse(sectionId) {
  const section = document.getElementById(sectionId);
  section.querySelector(".section-header").addEventListener("click", () => {
    section.classList.toggle("collapsed");
  });
}

window.addEventListener("DOMContentLoaded", () => {
  renderAttendance();
  renderLog();
  setupCollapse("attendanceSection");
  setupCollapse("logSection");
  
  // Simulated Header Load
  document.getElementById("dhName").textContent = "Admin Supervisor";
  document.getElementById("dhId").textContent = "SUP-991";
  document.getElementById("dhUnit").textContent = "MAINT-01";
  document.getElementById("dhStatus").textContent = "On Duty";
  document.getElementById("dhStatus").classList.add("on-duty");
  document.getElementById("dhInitials").textContent = "AS";
});
</script>
</body>
</html>
