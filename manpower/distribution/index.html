<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance & Manpower Dashboard</title>

<style>
/* 
  Refined Global Styles 
  Theme Primary: #259ba8
*/
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --primary: #259ba8;
  --primary-hover: #1e7d88;
  --primary-soft: #e9f5f6;
  --primary-light: #f1f9f9;
  --primary-dark: #176068;
  
  --bg: #f8fafb;
  --card-bg: #ffffff;
  --text-main: #1a2e30;
  --text-muted: #64748b;
  --border-color: #e2e8f0;
  
  /* Semantic Status Palette */
  --green: #10b981;
  --green-bg: #ecfdf5;
  --red: #ef4444;
  --red-bg: #fef2f2;
  --amber: #f59e0b;
  --amber-bg: #fffbeb;
  --slate: #64748b;
  --slate-bg: #f8fafb;

  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.04), 0 4px 6px -4px rgb(0 0 0 / 0.02);
}

* {
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  background-color: var(--bg);
  background-image: radial-gradient(at 0% 0%, rgba(37, 155, 168, 0.03) 0, transparent 50%), 
                    radial-gradient(at 50% 0%, rgba(37, 155, 168, 0.05) 0, transparent 50%);
  color: var(--text-main);
  font-family: 'Inter', -apple-system, system-ui, sans-serif;
  line-height: 1.5;
  padding: 40px 0;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  flex-direction: column;
  gap: 28px;
}

/* Modern Card Architecture */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-lg);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Header & Profile Refinement */
.header-card {
  padding: 40px;
  display: flex;
  align-items: center;
  gap: 40px;
  position: relative;
  overflow: hidden;
}

.header-card::after {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 200px; height: 200px;
  background: radial-gradient(circle, var(--primary-soft) 0%, transparent 70%);
  z-index: 0;
  opacity: 0.5;
}

.profile-pic {
  width: 96px;
  height: 96px;
  border-radius: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 36px;
  font-weight: 700;
  box-shadow: 0 12px 24px rgba(37, 155, 168, 0.3);
  position: relative;
  z-index: 1;
  flex-shrink: 0;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 32px;
  width: 100%;
  position: relative;
  z-index: 1;
}

.info-item {
  display: flex;
  flex-direction: column;
}

.info-item span:first-child {
  color: var(--text-muted);
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}

.info-item span:last-child {
  font-size: 17px;
  font-weight: 600;
  color: var(--text-main);
}

/* Collapsible Sections & Headers */
.section-header {
  padding: 24px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  background: #fff;
  border-radius: 16px;
  transition: all 0.2s ease;
}

.section-header:hover {
  background: var(--primary-light);
}

.section-header h2 {
  font-size: 14px;
  font-weight: 700;
  margin: 0;
  color: var(--primary-dark);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  display: flex;
  align-items: center;
  gap: 12px;
}

.chevron {
  color: var(--primary);
  font-size: 12px;
  background: var(--primary-soft);
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.section.collapsed .chevron {
  transform: rotate(-90deg);
}

/* Content Area Spacing */
.section-content {
  padding: 0 32px 32px 32px;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.sub-group-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--primary-dark);
  margin: 32px 0 16px 0;
  display: flex;
  align-items: center;
  gap: 15px;
}

.sub-group-title::after {
  content: "";
  height: 2px;
  flex-grow: 1;
  background: linear-gradient(to right, var(--primary-soft), transparent);
}

/* Premium Table UI */
.table-wrapper {
  background: #fff;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

table {
  width: 100%;
  border-collapse: collapse;
  text-align: left;
}

th {
  background: #fcfdfe;
  padding: 16px 20px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border-color);
}

td {
  padding: 16px 20px;
  font-size: 14px;
  border-bottom: 1px solid var(--primary-light);
  color: var(--text-main);
  transition: background 0.2s ease;
}

tr:last-child td {
  border-bottom: none;
}

tr:hover td {
  background-color: var(--primary-light);
}

/* High-End Status Badges */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}

.badge::before {
  content: "";
  width: 7px;
  height: 7px;
  border-radius: 50%;
  box-shadow: 0 0 0 2px currentColor;
  opacity: 0.8;
}

.status-green, .bg-present { 
  background: var(--green-bg); color: #065f46; 
}
.status-red, .bg-absent { 
  background: var(--red-bg); color: #991b1b; 
}
.bg-idle { 
  background: var(--amber-bg); color: #92400e; 
}
.bg-completed { 
  background: var(--slate-bg); color: #334155; 
  border: 1px solid var(--border-color);
}

/* Empty States */
.empty-state, .empty-state-main {
  padding: 48px;
  text-align: center;
  color: var(--text-muted);
  background: var(--primary-light);
  border-radius: 12px;
  border: 1px dashed var(--primary);
  font-size: 14px;
  font-weight: 500;
  margin: 10px 0;
}

/* Logic for Collapse */
.section.collapsed .section-content {
  display: none;
}

/* Responsive Scaling */
@media (max-width: 768px) {
  body { padding: 20px 0; }
  .container { padding: 0 16px; }
  .header-card { 
    flex-direction: column; 
    text-align: center; 
    padding: 32px 24px; 
    gap: 24px; 
  }
  .info-grid { 
    grid-template-columns: 1fr 1fr; 
    gap: 20px; 
    text-align: left;
  }
  .profile-pic { margin: 0 auto; }
  .table-wrapper { overflow-x: auto; }
  th, td { padding: 12px 16px; }
}

@media (max-width: 480px) {
  .info-grid { grid-template-columns: 1fr; }
}
</style>
  
</head>
<body>
<div class="container">

  <!-- SECTION 1 -->
  <div class="card header-card">
    <div class="profile-pic" id="dhInitials">--</div>
    <div class="info-grid">
      <div class="info-item"><span>Name:</span> <span id="dhName">Loading...</span></div>
      <div class="info-item"><span>Employee ID:</span> <span id="dhId">...</span></div>
      <div class="info-item"><span>Department Code:</span> <span id="dhUnit">...</span></div>
      <div class="info-item">
        <span>Attended Status:</span>
        <span id="dhStatus" class="badge">Checking...</span>
      </div>
    </div>
  </div>

  <!-- SECTION 2: ATTENDANCE GROUPS -->
  <div class="card section" id="attendanceSection">
    <div class="section-header">
      <h2>Manpower Attendance Status</h2>
      <div class="chevron">▼</div>
    </div>
    
    <div class="section-content">
      <!-- Main Empty State: Shown if no records at all exist for the unit today -->
      <div id="mainEmptyState" class="empty-state-main" style="display:none; text-align: center; padding: 20px; color: #666; font-weight: bold; border: 1px dashed #ccc; border-radius: 8px; margin: 10px;">
        No Attendance Record For Today
      </div>

      <!-- Container for the tables -->
      <div id="attendanceContent">
        <!-- Group 1: ON DUTY -->
        <div class="sub-group-title">ON DUTY PERSONNEL</div>
        <div class="table-wrapper">
          <table id="onDutyTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Clock-In</th>
                <th>Assignment Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="empty-state" id="onDutyEmpty" style="display:none;">No personnel on duty</div>
        </div>

        <!-- Group 2: OFF DUTY -->
        <div class="sub-group-title">OFF DUTY PERSONNEL</div>
        <div class="table-wrapper">
          <table id="offDutyTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Clock-In</th>
                <th>Clock-Out</th>
                <th>Completion Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="empty-state" id="offDutyEmpty" style="display:none;">No personnel off duty</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SECTION 3: ACTION LOG -->
  <div class="card section collapsed" id="logSection">
    <div class="section-header">
      <h2>Manpower Action Log</h2>
      <div class="chevron">▼</div>
    </div>
    <div class="section-content">
      <div class="table-wrapper">
        <table id="logTable">
          <thead>
            <tr>
              <th>Employee ID</th>
              <th>Work Order</th>
              <th>Task</th>
              <th>Time</th>
              <th>Action</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- JavaScript will inject rows here -->
          </tbody>
        </table>
      </div>
      <!-- Updated empty state message -->
      <div class="empty-state" id="logEmpty" style="display:none;">No Action Log for today</div>
    </div>
  </div>

</div>

<script src="../../auth/script.js"></script>
<script>
  
// 1. Protect the page and get user info
const user = protectPage();
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4MAK0BJYSFKhx70R7JIasZnwRFhGrTPOCsZmo16R8b9Gzim5gZSrTgOSUTqoYUOFVKQ/exec"; 

  
/**
 * Fetch and Fill Department Head Data */
  
async function loadDHHeader() {
  if (!user || !user.userId) {
    console.warn("User not logged in yet...");
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?userId=${user.userId}&action=getDHData`);
    const data = await response.json();

    if (data.success) {
      // Fill Text Data
      document.getElementById("dhName").textContent = data.name;
      document.getElementById("dhId").textContent = data.id;
      document.getElementById("dhUnit").textContent = data.unit;
      
      // Handle Initials
      const initials = data.name.split(" ").map(n => n[0]).join("").toUpperCase();
      document.getElementById("dhInitials").textContent = initials.substring(0, 2);

      // --- SYNC STATUS & CSS ---
      const statusBadge = document.getElementById("dhStatus");
      let displayText = "";
      let cssClass = "";

      switch (data.attendanceStatus) {
        case "On Duty":
          displayText = "On Duty";
          cssClass = "bg-present"; // Green
          break;
        case "Not Yet Present":
        case "Absent":
          displayText = data.attendanceStatus;
          cssClass = "bg-absent";  // Red
          break;
        case "On Leave":
          displayText = "On Leave";
          cssClass = "bg-idle";    // Yellow
          break;
        case "Shift Completed":
          displayText = "Off Duty";
          cssClass = "bg-completed"; // Grey
          break;
        default:
          displayText = data.attendanceStatus || "Unknown";
          cssClass = "bg-idle";
      }

      statusBadge.textContent = displayText;
      // IMPORTANT: Reset classes and apply 'badge' + the specific color class
      statusBadge.className = `badge ${cssClass}`;
      
    } else {
      document.getElementById("dhName").textContent = "Data Not Found";
    }
  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("dhName").textContent = "Connection Error";
  }
}

async function fetchAndRenderAttendance() {
  const user = protectPage();
  if (!user || !user.unit) return;
  try {
    const response = await fetch(`${WEB_APP_URL}?action=getAttendanceData&unit=${encodeURIComponent(user.unit)}`);
    const data = await response.json();
    renderAttendance(data);
  } catch (error) {
    console.error("Error:", error);
    renderAttendance([]);
  }
}

function renderAttendance(data) {
  const onDutyBody = document.querySelector("#onDutyTable tbody");
  const offDutyBody = document.querySelector("#offDutyTable tbody");
  
  onDutyBody.innerHTML = "";
  offDutyBody.innerHTML = "";

  const onDutyList = data.filter(p => p.isDuty);
  const offDutyList = data.filter(p => !p.isDuty);

  // Toggle empty state visibility
  document.getElementById("onDutyEmpty").style.display = onDutyList.length === 0 ? "block" : "none";
  document.getElementById("offDutyEmpty").style.display = offDutyList.length === 0 ? "block" : "none";

  // Render Group 1: On Duty
  onDutyList.forEach(p => {
    const statusClass = p.status === "On Task" ? "status-green" : "bg-idle"; // Green for working, Yellow for Idle
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    onDutyBody.appendChild(tr);
  });

  // Render Group 2: Off Duty
  offDutyList.forEach(p => {
    const statusClass = p.status === "Required STOP" ? "status-red" : "bg-completed"; // Red for Error, Grey for Finished
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td>${p.clockOut}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    offDutyBody.appendChild(tr);
  });
}
  

// Revised fetchAndRenderLog
async function fetchAndRenderLog(unit) {
  const logTableBody = document.querySelector("#logTable tbody");
  const logEmpty = document.getElementById("logEmpty");
  
  if (!unit) {
    logEmpty.style.display = "block";
    logEmpty.innerText = "Unit not identified.";
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?action=getActionLog&unit=${encodeURIComponent(unit)}`);
    const data = await response.json();

    logTableBody.innerHTML = ""; // Clear existing rows

    if (!data || data.length === 0) {
      logEmpty.style.display = "block";
      return;
    }

    logEmpty.style.display = "none";
    
    const rowsHtml = data.map(row => {
      let statusClass = "bg-completed"; 
      const status = (row.status || "").toLowerCase();
      
      if (status.includes("progress") || status.includes("running")) statusClass = "bg-idle";
      if (status.includes("start") || status.includes("open")) statusClass = "status-green";
      if (status.includes("stop") || status.includes("hold")) statusClass = "status-red";

      return `
        <tr>
          <td><strong>${row.employeeId}</strong></td>
          <td>${row.workOrder}</td>
          <td>${row.task}</td>
          <td>${row.time}</td>
          <td>${row.action}</td>
          <td><span class="badge ${statusClass}">${row.status}</span></td>
        </tr>
      `;
    }).join('');

    logTableBody.innerHTML = rowsHtml;

  } catch (error) {
    console.error("Log Error:", error);
    logEmpty.style.display = "block";
    logEmpty.innerText = "Error loading logs.";
  }
}


function setupCollapse(sectionId) {
  const section = document.getElementById(sectionId);
  section.querySelector(".section-header").addEventListener("click", () => {
    section.classList.toggle("collapsed");
  });
}

// --- IMPORTANT: Fixed DOMContentLoaded ---
window.addEventListener("DOMContentLoaded", () => {
  setupCollapse("attendanceSection");
  setupCollapse("logSection");
  
  loadDHHeader(); 
  
  // Call functions using the 'user' object retrieved at top of script
  if (user && user.unit) {
    fetchAndRenderAttendance();
    fetchAndRenderLog(user.unit); // Pass the unit here
  }
});
  
</script>
</body>
</html>
