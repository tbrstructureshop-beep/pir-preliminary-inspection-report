<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manpower Distribution</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="/assets/logo.png">
  
<style>
  :root {
    /* Updated to your preferred color #2595a8 */
    --primary: #2595a8; 
    --primary-dark: #1d7685;
    --primary-light: #e9f5f7;
    --primary-glow: rgba(37, 149, 168, 0.15);
    
    --bg-gradient: radial-gradient(at 0% 0%, #f8fafc 0px, transparent 50%), 
                   radial-gradient(at 100% 100%, #f1f5f9 0px, transparent 50%);
    --card-bg: rgba(255, 255, 255, 0.95);
    --text-main: #1e293b;
    --text-sub: #64748b;
    --border: #e2e8f0;
    --radius-lg: 20px;
    --radius-md: 12px;
    --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 20px 25px -5px rgba(37, 149, 168, 0.1), 0 8px 10px -6px rgba(37, 149, 168, 0.05);
    
    /* Status Colors */
    --success: #10b981;
    --success-bg: #ecfdf5;
    --danger: #ef4444;
    --danger-bg: #fef2f2;
    --warning: #f59e0b;
    --warning-bg: #fffbeb;
    --info: #3b82f6;
    --info-bg: #eff6ff;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
  }

  body {
    background-color: #f8fafc;
    background-image: var(--bg-gradient);
    color: var(--text-main);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 40px 20px;
    line-height: 1.6;
  }

  .app {
    width: 100%;
    max-width: 1100px;
    display: flex;
    flex-direction: column;
    gap: 28px;
    animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- HEADER WITH YOUR COLOR --- */
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: var(--radius-lg);
    padding: 32px;
    box-shadow: 0 12px 30px -10px rgba(37, 149, 168, 0.4);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  header::before {
    content: '';
    position: absolute;
    width: 300px;
    height: 300px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    top: -100px;
    right: -50px;
  }

  .profile-info {
    display: flex;
    align-items: center;
    gap: 20px;
    z-index: 1;
  }

  .profile-pic {
    width: 64px;
    height: 64px;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.4rem;
  }

  .greeting h1 {
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .employee-meta {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-top: 4px;
    display: flex;
    gap: 12px;
  }

  /* --- SECTION CARDS --- */
  .section-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 1px solid white;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .section-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 25px 50px -12px rgba(37, 149, 168, 0.15);
  }

  .section-header {
    padding: 24px 28px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .section-header h2 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-main);
    display: flex;
    align-items: center;
    gap: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Icon backgrounds use your new color */
  .section-header i.fa-users-viewfinder, 
  .section-header i.fa-list-check {
    color: var(--primary);
    background: var(--primary-light);
    padding: 8px;
    border-radius: 10px;
  }

  .chevron {
    color: var(--text-sub);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .collapsed .chevron { transform: rotate(-180deg); }
  .collapsed .section-content { display: none; }

  .section-content {
    padding: 0 28px 28px 28px;
  }

  /* --- MODERN TABLES --- */
  .table-container {
    width: 100%;
    overflow-x: auto;
    border-radius: var(--radius-md);
    background: white;
    border: 1px solid var(--border);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  th {
    background: #fcfcfd;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: var(--text-sub);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    color: var(--text-main);
    transition: background 0.2s ease;
  }

  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--primary-light); }

  /* --- PILL BADGES --- */
  .badge {
    padding: 6px 14px;
    border-radius: 100px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .bg-present { background: var(--success-bg); color: var(--success); }
  .bg-absent { background: var(--danger-bg); color: var(--danger); }
  .bg-idle { background: var(--warning-bg); color: var(--warning); }
  .bg-completed { background: #f1f5f9; color: #475569; }

  /* --- SUB-GROUP TITLES --- */
  .sub-group-wrapper { margin-top: 32px; }
  .sub-group-title {
    font-size: 0.8rem;
    font-weight: 800;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-sub);
  }

  .title-on-duty i { color: var(--success); }
  .title-off-duty i { color: var(--text-sub); }

  /* --- EMPTY STATE --- */
  .empty-state {
    padding: 40px;
    text-align: center;
    color: var(--text-sub);
    font-size: 0.85rem;
    background: #f8fafc;
    border: 2px dashed var(--border);
    border-radius: var(--radius-md);
    margin: 10px 0;
  }

  /* --- RESPONSIVE --- */
  @media (max-width: 768px) {
    body { padding: 20px 10px; }
    header { padding: 24px 20px; flex-direction: column; align-items: flex-start; gap: 20px; }
    .section-header { padding: 20px; }
    .section-content { padding: 0 15px 20px; }
  }
</style>
</head>

<body>
  <div class="app">
    <!-- PROFILE HEADER -->
    <header>
      <div class="profile-info">
        <div class="profile-pic" id="dhInitials">--</div>
        <div class="greeting">
          <h1 id="dhName">Loading Dashboard...</h1>
          <div class="employee-meta">
            <span><i class="far fa-id-badge"></i> <span id="dhId">...</span></span>
            <span><i class="far fa-building"></i> <span id="dhUnit">...</span></span>
          </div>
        </div>
      </div>
      <div id="dhStatus" class="badge bg-idle">Syncing...</div>
    </header>

    <!-- ATTENDANCE SECTION -->
    <div class="section-card" id="attendanceSection">
      <div class="section-header">
        <h2><i class="fas fa-users-viewfinder"></i> Manpower Attendance</h2>
        <i class="fas fa-chevron-up chevron"></i>
      </div>
      
      <div class="section-content">
        <!-- ON DUTY -->
        <div class="sub-group-wrapper" style="margin-top: 0;">
          <div class="sub-group-title title-on-duty">
            <i class="fas fa-circle-check"></i> ACTIVE PERSONNEL
          </div>
          <div class="table-container">
            <table id="onDutyTable">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Full Name</th>
                  <th>Clocked In</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="empty-state" id="onDutyEmpty" style="display:none;">No personnel currently active</div>
          </div>
        </div>

        <!-- OFF DUTY -->
        <div class="sub-group-wrapper">
          <div class="sub-group-title title-off-duty">
            <i class="fas fa-moon"></i> RECENTLY OFF DUTY
          </div>
          <div class="table-container">
            <table id="offDutyTable">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Full Name</th>
                  <th>In</th>
                  <th>Out</th>
                  <th>Final Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="empty-state" id="offDutyEmpty" style="display:none;">No off-duty records for today</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTION LOG SECTION -->
    <div class="section-card collapsed" id="logSection">
      <div class="section-header">
        <h2><i class="fas fa-list-check"></i> Operational Action Log</h2>
        <i class="fas fa-chevron-up chevron"></i>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th>Personnel</th>
                <th>Work Order</th>
                <th>Task Description</th>
                <th>Timestamp</th>
                <th>Action</th>
                <th>Current Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="empty-state" id="logEmpty" style="display:none;">No activity logged for the selected period</div>
      </div>
    </div>
  </div>

<script src="../../auth/script.js"></script>
<script>
  
// 1. Protect the page and get user info
const user = protectPage();
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4MAK0BJYSFKhx70R7JIasZnwRFhGrTPOCsZmo16R8b9Gzim5gZSrTgOSUTqoYUOFVKQ/exec"; 

  
/**
 * Fetch and Fill Department Head Data */
  
async function loadDHHeader() {
  if (!user || !user.userId) {
    console.warn("User not logged in yet...");
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?userId=${user.userId}&action=getDHData`);
    const data = await response.json();

    if (data.success) {
      // Fill Text Data
      document.getElementById("dhName").textContent = data.name;
      document.getElementById("dhId").textContent = data.id;
      document.getElementById("dhUnit").textContent = data.unit;
      
      // Handle Initials
      const initials = data.name.split(" ").map(n => n[0]).join("").toUpperCase();
      document.getElementById("dhInitials").textContent = initials.substring(0, 2);

      // --- SYNC STATUS & CSS ---
      const statusBadge = document.getElementById("dhStatus");
      let displayText = "";
      let cssClass = "";

      switch (data.attendanceStatus) {
        case "On Duty":
          displayText = "On Duty";
          cssClass = "bg-present"; // Green
          break;
        case "Not Yet Present":
        case "Absent":
          displayText = data.attendanceStatus;
          cssClass = "bg-absent";  // Red
          break;
        case "On Leave":
          displayText = "On Leave";
          cssClass = "bg-idle";    // Yellow
          break;
        case "Shift Completed":
          displayText = "Off Duty";
          cssClass = "bg-completed"; // Grey
          break;
        default:
          displayText = data.attendanceStatus || "Unknown";
          cssClass = "bg-idle";
      }

      statusBadge.textContent = displayText;
      // IMPORTANT: Reset classes and apply 'badge' + the specific color class
      statusBadge.className = `badge ${cssClass}`;
      
    } else {
      document.getElementById("dhName").textContent = "Data Not Found";
    }
  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("dhName").textContent = "Connection Error";
  }
}

async function fetchAndRenderAttendance() {
  const user = protectPage();
  if (!user || !user.unit) return;
  try {
    const response = await fetch(`${WEB_APP_URL}?action=getAttendanceData&unit=${encodeURIComponent(user.unit)}`);
    const data = await response.json();
    renderAttendance(data);
  } catch (error) {
    console.error("Error:", error);
    renderAttendance([]);
  }
}

function renderAttendance(data) {
  const onDutyBody = document.querySelector("#onDutyTable tbody");
  const offDutyBody = document.querySelector("#offDutyTable tbody");
  
  onDutyBody.innerHTML = "";
  offDutyBody.innerHTML = "";

  const onDutyList = data.filter(p => p.isDuty);
  const offDutyList = data.filter(p => !p.isDuty);

  // Toggle empty state visibility
  document.getElementById("onDutyEmpty").style.display = onDutyList.length === 0 ? "block" : "none";
  document.getElementById("offDutyEmpty").style.display = offDutyList.length === 0 ? "block" : "none";

  // Render Group 1: On Duty
  onDutyList.forEach(p => {
    const statusClass = p.status === "On Task" ? "status-green" : "bg-idle"; // Green for working, Yellow for Idle
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    onDutyBody.appendChild(tr);
  });

  // Render Group 2: Off Duty
  offDutyList.forEach(p => {
    const statusClass = p.status === "Required STOP" ? "status-red" : "bg-completed"; // Red for Error, Grey for Finished
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.clockIn}</td>
      <td>${p.clockOut}</td>
      <td><span class="badge ${statusClass}">${p.status}</span></td>
    `;
    offDutyBody.appendChild(tr);
  });
}
  

// Revised fetchAndRenderLog
async function fetchAndRenderLog(unit) {
  const logTableBody = document.querySelector("#logTable tbody");
  const logEmpty = document.getElementById("logEmpty");
  
  if (!unit) {
    logEmpty.style.display = "block";
    logEmpty.innerText = "Unit not identified.";
    return;
  }

  try {
    const response = await fetch(`${WEB_APP_URL}?action=getActionLog&unit=${encodeURIComponent(unit)}`);
    const data = await response.json();

    logTableBody.innerHTML = ""; // Clear existing rows

    if (!data || data.length === 0) {
      logEmpty.style.display = "block";
      return;
    }

    logEmpty.style.display = "none";
    
    const rowsHtml = data.map(row => {
      let statusClass = "bg-completed"; 
      const status = (row.status || "").toLowerCase();
      
      if (status.includes("progress") || status.includes("running")) statusClass = "bg-idle";
      if (status.includes("start") || status.includes("open")) statusClass = "status-green";
      if (status.includes("stop") || status.includes("hold")) statusClass = "status-red";

      return `
        <tr>
          <td><strong>${row.employeeId}</strong></td>
          <td>${row.workOrder}</td>
          <td>${row.task}</td>
          <td>${row.time}</td>
          <td>${row.action}</td>
          <td><span class="badge ${statusClass}">${row.status}</span></td>
        </tr>
      `;
    }).join('');

    logTableBody.innerHTML = rowsHtml;

  } catch (error) {
    console.error("Log Error:", error);
    logEmpty.style.display = "block";
    logEmpty.innerText = "Error loading logs.";
  }
}


function setupCollapse(sectionId) {
  const section = document.getElementById(sectionId);
  section.querySelector(".section-header").addEventListener("click", () => {
    section.classList.toggle("collapsed");
  });
}

// --- IMPORTANT: Fixed DOMContentLoaded ---
window.addEventListener("DOMContentLoaded", () => {
  setupCollapse("attendanceSection");
  setupCollapse("logSection");
  
  loadDHHeader(); 
  
  // Call functions using the 'user' object retrieved at top of script
  if (user && user.unit) {
    fetchAndRenderAttendance();
    fetchAndRenderLog(user.unit); // Pass the unit here
  }
});
  
</script>
</body>
</html>
