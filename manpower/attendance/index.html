<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Attendance</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #307c91;
      --primary-dark: #245f6f;
      --primary-light: #e6f1f4;
      --bg: #f0f4f7;
      --card: #ffffff;
      --text-main: #0f2f36;
      --text-sub: #5f7f88;
      --accent: #3fa2b8;
      --radius: 16px;
      --shadow: 0 10px 25px -5px rgba(48, 124, 145, 0.1), 0 8px 10px -6px rgba(48, 124, 145, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }

    body {
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(48, 124, 145, 0.05) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(63, 162, 184, 0.05) 0px, transparent 50%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 20px; animation: fadeIn 0.6s ease-out; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: var(--radius);
      padding: 28px 24px;
      box-shadow: var(--shadow);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .greeting { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
    .employee-meta { font-size: 0.85rem; opacity: 0.9; margin-bottom: 16px; font-weight: 300; }
    .date-badge { display: inline-block; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(4px); padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; }

    .summary { display: grid; grid-template-columns: 1fr; gap: 12px; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.8);
    }

    .card-icon { width: 42px; height: 42px; border-radius: 10px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .card-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: var(--text-sub); letter-spacing: 0.5px; }
    .card-value { font-size: 1.15rem; font-weight: 700; }

    /* History Section Styling */
    .history-section {
      background: #f8fafc;
      border-radius: var(--radius);
      padding: 20px;
      border: 1px dashed #cbd5e1;
    }
    .history-title { font-size: 0.75rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .history-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .history-item { display: flex; flex-direction: column; }
    .history-label { font-size: 0.65rem; color: #94a3b8; font-weight: 600; }
    .history-val { font-size: 0.85rem; font-weight: 700; color: #1e293b; }

    .actions { display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
    button { border: none; border-radius: var(--radius); padding: 18px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 14px 0 rgba(48, 124, 145, 0.39); }
    .btn-primary:hover { transform: scale(1.02); }
    .btn-secondary { background: #fff; color: var(--text-sub); border: 1px solid #e2e8f0; }
    .status-out { background: #ef4444 !important; box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.39) !important; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="greeting" id="greeting">Loading...</div>
      <div class="employee-meta" id="employeeMeta">Please wait...</div>
      <div class="date-badge"><i class="far fa-calendar-alt"></i> &nbsp;<span id="todayDate">-- --- ----</span></div>
    </header>

    <section class="summary">
      <div class="card">
        <div class="card-icon"><i class="fas fa-sign-in-alt"></i></div>
        <div class="card-info">
          <div class="card-label">Today's Clock In</div>
          <div class="card-value" id="clockIn">--:--</div>
        </div>
      </div>
      <div class="card">
        <div class="card-icon"><i class="fas fa-sign-out-alt"></i></div>
        <div class="card-info">
          <div class="card-label">Today's Clock Out</div>
          <div class="card-value" id="clockOut">--:--</div>
        </div>
      </div>
      <div class="card">
        <div class="card-icon"><i class="fas fa-stopwatch"></i></div>
        <div class="card-info">
          <div class="card-label">Today's Work Duration</div>
          <div class="card-value" id="duration">--:--:--</div>
        </div>
      </div>
    </section>

    <!-- NEW HISTORY SECTION -->
    <section class="history-section">
      <div class="history-title"><i class="fas fa-history"></i> Last Session History</div>
      <div class="history-grid">
        <div class="history-item">
          <span class="history-label">Previous In</span>
          <span class="history-val" id="histIn">--</span>
        </div>
        <div class="history-item">
          <span class="history-label">Previous Out</span>
          <span class="history-val" id="histOut">--</span>
        </div>
        <div class="history-item" style="grid-column: span 2; margin-top: 4px; border-top: 1px solid #e2e8f0; padding-top: 8px;">
          <span class="history-label">Calculated Duration</span>
          <span class="history-val" id="histDur" style="color:var(--primary)">--</span>
        </div>
      </div>
    </section>

    <section class="actions">
      <button class="btn-primary" id="clockButton"><i class="fas fa-fingerprint"></i> Clock In</button>
      <button class="btn-secondary"><i class="fas fa-bars"></i> Main Menu</button>
    </section>
  </div>

<script src="../../auth/script.js"></script>
<script>
  const ALLOWED_IPS = ["118.97.115.66", "118.97.70.226"];
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4MAK0BJYSFKhx70R7JIasZnwRFhGrTPOCsZmo16R8b9Gzim5gZSrTgOSUTqoYUOFVKQ/exec";

  // Helper to turn seconds into "1h 5m" or "5m 12s"
  function formatDuration(totalSeconds) {
    if (totalSeconds === null || totalSeconds === undefined || totalSeconds <= 0) return "--:--:--";
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return h > 0 ? `${h}h ${m}m` : `${m}m ${s}s`;
  }

  async function verifyCompanyWiFi() {
    try {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      if (ALLOWED_IPS.includes(data.ip)) { initializeApp(); } 
      else { showWifiError(data.ip); }
    } catch (error) { showWifiError("Offline"); }
  }

  function showWifiError(detectedIP) {
    document.body.innerHTML = `<div style="text-align:center; padding:50px;"><h1>Access Restricted</h1><p>Connect to GMF-AeroAsia WiFi</p><b>IP: ${detectedIP}</b></div>`;
  }

  async function initializeApp() {
    const user = protectPage();
    const { name: employeeName, userId: employeeId, unit: department, jobTitle } = user;
    let isClockedIn = false;

    const clockInEl = document.getElementById("clockIn");
    const clockOutEl = document.getElementById("clockOut");
    const durationEl = document.getElementById("duration");
    const clockButton = document.getElementById("clockButton");

    // History elements
    const histInEl = document.getElementById("histIn");
    const histOutEl = document.getElementById("histOut");
    const histDurEl = document.getElementById("histDur");

    try {
      const resp = await fetch(`${WEB_APP_URL}?userId=${employeeId}`);
      const status = await resp.json();

      // 1. Set Today's Status
      if (status.clockIn) clockInEl.textContent = status.clockIn;
      if (status.clockOut) clockOutEl.textContent = status.clockOut;
      
      // Only show duration in main card if user is currently Clocked Out today
      if (status.lastAction === "CLOCK OUT") {
        durationEl.textContent = formatDuration(status.historyDuration);
      }

      // 2. Set History Status (Absolute Last Session)
      histInEl.textContent = status.historyIn || "--";
      histOutEl.textContent = status.historyOut || "--";
      histDurEl.textContent = formatDuration(status.historyDuration);

      // 3. Set Button State
      if (status.lastAction === "CLOCK IN") {
        isClockedIn = true;
        clockButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Clock Out';
        clockButton.classList.add("status-out");
      }
    } catch (e) { console.log("Init error:", e); }

    if(clockButton) {
      clockButton.addEventListener("click", async () => {
        const action = !isClockedIn ? "CLOCK IN" : "CLOCK OUT";
        clockButton.disabled = true;
        clockButton.style.opacity = "0.5";

        try {
          await fetch(WEB_APP_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({ userId: employeeId, name: employeeName, title: jobTitle, unit: department, action: action }) 
          });

          if (action === "CLOCK IN") {
            window.location.reload(); // Reload to refresh history and today's status
          } else {
            // Give the sheet a moment to process the calculation
            setTimeout(() => window.location.reload(), 1200);
          }
        } catch (err) {
          alert("Error saving. Try again.");
          clockButton.disabled = false;
        }
      });
    }

    document.getElementById("greeting").textContent = `Good Day, ${employeeName}`;
    document.getElementById("employeeMeta").textContent = `${employeeId} • ${department} • ${jobTitle}`;
    document.getElementById("todayDate").textContent = new Date().toLocaleDateString("en-GB", {
      weekday: "long", day: "2-digit", month: "short", year: "numeric"
    });
  }

  window.addEventListener("DOMContentLoaded", verifyCompanyWiFi);
</script>
</body>
</html>
